import os
import cv2
from tqdm import tqdm

# Base directory (project root)
PROJECT_DIR = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))

# Define paths
RAW_DIR = os.path.join(PROJECT_DIR, "raw")
PRE_DIR = os.path.join(PROJECT_DIR, "preprocessed")

# Ensure preprocessed folder exists
os.makedirs(PRE_DIR, exist_ok=True)

def preprocess_image(img_path, output_path):
    # Read image
    img = cv2.imread(img_path)
    if img is None:
        print(f" Could not read image: {img_path}")
        return

    # 1️ Convert to grayscale
    gray = cv2.cvtColor(img, cv2.COLOR_BGR2GRAY)

    # 2️ Gaussian blur
    blur = cv2.GaussianBlur(gray, (3, 3), 0)

    # 3️ Adaptive threshold
    thresh = cv2.adaptiveThreshold(
        blur, 255, cv2.ADAPTIVE_THRESH_GAUSSIAN_C,
        cv2.THRESH_BINARY, 35, 11
    )

    # 4️ Resize
    resized = cv2.resize(thresh, (1200, 800))

    # 5️ Contrast enhancement
    enhanced = cv2.convertScaleAbs(resized, alpha=1.3, beta=15)

    # 6️ Save image (create directories if they don't exist)
    os.makedirs(os.path.dirname(output_path), exist_ok=True)
    cv2.imwrite(output_path, enhanced)
    print(f" Saved: {output_path}")

def main():
    images_to_process = []

    # Walk through raw folder recursively
    for root, dirs, files in os.walk(RAW_DIR):
        for file in files:
            if file.lower().endswith(('.jpg', '.jpeg', '.png')):
                full_path = os.path.join(root, file)
                # Preserve folder structure inside preprocessed
                rel_path = os.path.relpath(full_path, RAW_DIR)
                out_path = os.path.join(PRE_DIR, rel_path)
                images_to_process.append((full_path, out_path))

    if len(images_to_process) == 0:
        print(f" No images found in {RAW_DIR} or its subfolders.")
        return

    print(f"Found {len(images_to_process)} images to process...")

    for in_path, out_path in tqdm(images_to_process):
        preprocess_image(in_path, out_path)

    print(f" Preprocessing complete! Images saved in {PRE_DIR}")

if __name__ == "__main__":
    main()

